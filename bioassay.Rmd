---
title: "Bioassays in fruits"
author: "Marisa A.A. Tudela"
date: "2023-03-01"
output:
  pdf_document: default
  html_document: default
---
# Bioassays in fruits

## Preventive treatments: Disease severity analysis (spots per fruit) 

```{r}
source(here::here("setup.R"))
sev_prev <- rio::import("data/bioassay.csv")
```


```{r}
str(sev_prev)
sev_prev$day<- as.factor(sev_prev$day)
sev_prev$repetition<- as.factor(sev_prev$repetition)
sev_prev$replicate<- as.factor(sev_prev$replicate)
str(sev_prev)
glimpse(sev_prev)
```


```{r}
```

Data scheme

```{r}
sev_prev %>% str
ftable(xtabs(~ treatment + day + repetition + replicate, sev_prev))

```

Graphics 

```{r warning=FALSE}
sev_prev %>% 
  ggplot() + 
  aes(x=treatment, y = spots_per_fruit) + 
  geom_boxplot() +  
  geom_boxplot(alpha=.5, width = .2) + 
  geom_jitter(col=2) + 
  geom_point(alpha=.7) + 
  labs(x="Treatment", y="Severity (spots per fruit)")

sev_prev %>% 
  ggplot() + 
  aes(x=treatment, y = spots_per_fruit) + 
  geom_boxplot(alpha=.5, width = .2) + 
  geom_point(alpha=.7) + 
  labs(x="Treatments", y="Severity)")

plot(sev_prev$spots_per_fruit,method="stack", vertical=TRUE, pch=0, main="Dot plot", ylab="Spots per fruit", col="black")
ggplot(sev_prev,aes(x=treatment, y=spots_per_fruit, fill=treatment))+geom_bar(stat="identity")+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
a<- ggplot(sev_prev,aes(x=treatment, y=spots_per_fruit, fill=treatment))+geom_bar(stat="identity")+ facet_grid(.~day)
g_a <- a + scale_fill_grey()  
g_a
```

Model

```{r}
mod_gls3 <- gls(s.r.spots ~ 1 + treatment+day+treatment:day,
                weights=varComb(varIdent(form=~1|treatment*day)),
                method="REML", na.action=na.omit,data=sev_prev)
summary(mod_gls3)
car::Anova(mod_gls3, type="III")
sum(residuals(mod_gls3, type="pearson")^2)
pchisq(585, 585, lower.tail = F)

```

Means comparison test

```{r}
mediasml2 = emmeans(mod_gls3, ~ treatment*day) 

pairs(mediasml2, adjust= "Tukey")

glsinc = cld(mediasml2, alpha=0.05, Letters=letters, adjust= "sidak")
glsinc
glsinc1 = as.tibble(glsinc)
pd  <- position_dodge(0.9) 
ggplot(glsinc1, aes(x = treatment, y = emmean, fill= treatment)) +
  facet_wrap(~day) + geom_col(position ="dodge")  + 
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), 
                colour = "black", width=0.4, position = pd) + 
  geom_point(position=pd, size=3,  col = "blue")+ 
  geom_text(aes(label = .group, y = emmean + SE),position=pd, hjust = -0.01) + 
  ylab("Spots per fruit emmeans")
```


```{r}
glsimedia2022  <- emmeans(mod_gls3, ~ treatment*day, by = "day")
pairs(glsimedia2022 , adjust= "Tukey", type="response")
medias_conjunto = cld(glsimedia2022, alpha=0.05, Letters=letters, adjust= "Tukey")
medias_conjunto

anidado_prev = as.tibble(medias_conjunto)
pd  <- position_dodge(0.9) 
ggplot(anidado_prev, aes(x = treatment, y = emmean, fill= treatment)) + facet_wrap(~day) + 
  geom_col(position = "dodge")  + 
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), colour = "black", width=0.1, position = pd) + geom_point(position=pd, size=3,  col = "blue")+ geom_text(aes(label = .group, y = emmean + SE),position=pd, hjust = -0.4) + ylab("Spots per fruit emmeans")
```


```{r}
```


Disease incidence analysis (proportion of affected fruit) 

**Bellis day 1- Bellis day 7:** 
```{r}
prop.test(c(5,30),n=c(40,40))
```
**Bellis day 1 – Merpan day 1:**
```{r}
prop.test(c(5,18),n=c(40,40)) 
```
**Bellis day 1 – Ziram day 1:**
```{r}
prop.test(c(5,25),n=c(40,40))
```

**Ziram day 7 – Ziram 15:**
```{r}
prop.test(c(25,40),n=c(40,40))
```
**Ziram day 1 – Merpan day 1:**
```{r}
prop.test(c(25,18),n=c(40,40))

```


## Curative treatments: Disease severity analysis (spots per fruit) 

```{r}
curativo_dat<-read.table("data/curative_treatments.csv", sep=";", header=TRUE, dec=",")

curativo_dat$repetition<- as.factor(curativopaper$repetition)
curativo_dat$replicate<- as.factor(curativopaper$replicate)

```

Data scheme

```{r}
curativo_dat %>% str
ftable(xtabs(~ treatment + repetition + replicate, curativo_dat))

```

Graphics 

```{r warning=FALSE}
plot(curativo_dat$spots.per.fruit,method="stack", vertical=TRUE, pch=0, main="Dot plot", ylab="Spots per fruit", col="black")
ggboxplot(curativo_dat, y= "spots.per.fruit", x = c("treatment"), 
          merge = TRUE, color="treatment", pallete="jco")
ggplot(curativopaper,aes(x=treatment, y=spots.per.fruit, fill=treatment))+geom_bar(stat="identity")+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

Model

```{r warning=FALSE}
m_REML<- gls(r.s.spots ~1+treatment.,weights=varComb(varIdent(form=~1|treatment)),method="REML",na.action=na.omit,data=curativo_dat)
summary(m_REML)
performance::check_homogeneity(m_REML)
sum(residuals(m_REML, type="pearson")^2)
pchisq(195, 195, lower.tail = F)
Anova(m_REML, type="II")
```

Means comparison test
```{r}
mediasmd1 = emmeans(m_REML, ~ treatment)
pairs(mediasmd1, adjust= "Tukey")
cld(mediasmd1, alpha=0.05, Letters=letters, adjust= "Tukey")
mediasd1 = cld(mediasmd1, alpha=0.05, Letters=letters, adjust= "Tukey")
tablamedia = as.tibble(mediasd1)
pd  <- position_dodge(0.9) 

ggplot(tablamedia, aes(x = treatment, y = emmean, fill= treatment)) + geom_col(position = "dodge")  + geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), colour = "black", width=0.1, position = pd) + geom_point(position=pd, size=3,  col = "blue")+ geom_text(aes(label = .group, y = emmean + SE),position=pd, hjust = -0.01) + ylab("spots per fruit emmeans")
g_d1 <-ggplot(tablamedia, aes(x=reorder(Treatment.,-emmean), y=emmean, fill=Treatment.)) + geom_col(position = "dodge")  + geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), colour = "black", width=0.1, position = pd) + geom_point(position=pd, size=3,  col = "blue")+ geom_text(aes(label = .group, y = emmean + SE),position=pd, hjust = -0.4) + ylab("Spots per fruit emmeans")
g_d1a <- g_d1 + scale_fill_grey()
g_d1a
```

Disease incidence analysis (proportionality test).

**Bellis vs Control**
```{r warning=FALSE}
prop.test(c(18,20),n=c(20,20))
```
**Ziram vs Control**
```{r warning=FALSE}
prop.test(c(19,20),n=c(20,20))
```
**Merpan vs Bellis**
```{r warning=FALSE}
prop.test(c(19,18),n=c(20,20))
```




