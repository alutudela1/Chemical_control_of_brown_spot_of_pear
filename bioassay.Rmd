---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Bioassays in fruits

## Preventive treatments: 

Disease severity analysis (spots per fruit) 

```{r}
source(here::here("setup.R"))
# library(lme4)
library(glmmTMB)
library(DHARMa)
library(performance)
raw <- rio::import("data/bioassay_data.csv") %>% 
  select(fungicide, repetition, day, replicate, fruit, spots_per_fruit) 
```


```{r}
dat <- raw %>% 
  # mutate_at(vars(dose, colony_diameter), as.numeric) %>% 
  mutate_at(vars(fungicide, repetition, day, replicate, fruit), as.factor) %>% 
    mutate(fungicide=fct_relevel(fungicide, "control"))  

dat %>% str
```

Data scheme

```{r}
ftable(xtabs(~ fungicide + day + repetition + replicate, dat))
```

Graphics 

```{r}
dat %>% 
  ggplot() + 
  aes(x=day, y=spots_per_fruit) + 
  geom_boxplot(width=.5) + 
  geom_jitter(width=.2, col=2, alpha=.5) + 
  labs(x="Treatment", y="Severity (spots per fruit)") + 
  facet_grid(repetition~fungicide)
```

```{r}
dat %>% 
  count(spots_per_fruit) %>% 
  ggplot() + 
  aes(x=spots_per_fruit, y=n) + 
  geom_col()
```

Model fitting

```{r,eval=FALSE}
# https://glmmtmb.github.io/glmmTMB/articles/glmmTMB.pdf
fit_zipoisson <- glmmTMB(spots_per_fruit~fungicide*day +
                           (1|repetition/replicate),
               ziformula = ~1, family = poisson,
             dat)
# performance::check_overdispersion(fit_zipoisson)
# simulateResiduals(fit_zipoisson) %>% testResiduals()
```

```{r}
fit_zinbinom <- update(fit_zipoisson,family=nbinom2)
fit_zinbinom1 <- update(fit_zipoisson,family=nbinom1)
fit_twediee <- update(fit_zipoisson,family=tweedie())

fit_hnbinom1 <- update(fit_zinbinom1,
                       ziformula=~., data=dat,
                       family=truncated_nbinom1)

AIC(fit_zipoisson,fit_zinbinom,fit_zinbinom1, fit_twediee, fit_hnbinom1)

#               df      AIC
# fit_zipoisson 18 3895.200
# fit_zinbinom  19 3489.228
# fit_zinbinom1 19 3418.201
# fit_twediee   20 3405.606
# fit_hnbinom1  35       NA
```

```{r}
performance::check_overdispersion(fit_zinbinom1)
simulateResiduals(fit_zinbinom1) %>% testResiduals()
```

```{r}
car::Anova(fit_zinbinom1)
```

Means comparison test

```{r}
emm <- emmeans(fit_zinbinom1, ~ fungicide|day, type="response") 
res <- cld(mediasml2, alpha=0.05, Letters=letters,  type="response")
res

res %>% 
  ggplot()+
  aes(x=day, y =response)+
  geom_pointrange(aes(ymin=asymp.LCL , ymax=asymp.UCL))+
  geom_col(alpha=.2, width=.2)+
  facet_wrap("fungicide")
```

#########
HASTA ACA
#########


Disease incidence analysis (proportion of affected fruit) 

**Bellis day 1- Bellis day 7:** 
```{r}
prop.test(c(5,30),n=c(40,40))
```
**Bellis day 1 – Merpan day 1:**
```{r}
prop.test(c(5,18),n=c(40,40)) 
```
**Bellis day 1 – Ziram day 1:**
```{r}
prop.test(c(5,25),n=c(40,40))
```

**Ziram day 7 – Ziram 15:**
```{r}
prop.test(c(25,40),n=c(40,40))
```
**Ziram day 1 – Merpan day 1:**
```{r}
prop.test(c(25,18),n=c(40,40))

```


## Curative treatments: Disease severity analysis (spots per fruit) 

```{r}
curativo_dat<-read.table("data/curative_treatments.csv", sep=";", header=TRUE, dec=",")

curativo_dat$repetition<- as.factor(curativopaper$repetition)
curativo_dat$replicate<- as.factor(curativopaper$replicate)

```

Data scheme

```{r}
curativo_dat %>% str
ftable(xtabs(~ treatment + repetition + replicate, curativo_dat))

```

Graphics 

```{r warning=FALSE}
plot(curativo_dat$spots.per.fruit,method="stack", vertical=TRUE, pch=0, main="Dot plot", ylab="Spots per fruit", col="black")
ggboxplot(curativo_dat, y= "spots.per.fruit", x = c("treatment"), 
          merge = TRUE, color="treatment", pallete="jco")
ggplot(curativopaper,aes(x=treatment, y=spots.per.fruit, fill=treatment))+geom_bar(stat="identity")+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

Model

```{r warning=FALSE}
m_REML<- gls(r.s.spots ~1+treatment.,weights=varComb(varIdent(form=~1|treatment)),method="REML",na.action=na.omit,data=curativo_dat)
summary(m_REML)
performance::check_homogeneity(m_REML)
sum(residuals(m_REML, type="pearson")^2)
pchisq(195, 195, lower.tail = F)
Anova(m_REML, type="II")
```

Means comparison test
```{r}
mediasmd1 = emmeans(m_REML, ~ treatment)
pairs(mediasmd1, adjust= "Tukey")
cld(mediasmd1, alpha=0.05, Letters=letters, adjust= "Tukey")
mediasd1 = cld(mediasmd1, alpha=0.05, Letters=letters, adjust= "Tukey")
tablamedia = as.tibble(mediasd1)
pd  <- position_dodge(0.9) 

ggplot(tablamedia, aes(x = treatment, y = emmean, fill= treatment)) + geom_col(position = "dodge")  + geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), colour = "black", width=0.1, position = pd) + geom_point(position=pd, size=3,  col = "blue")+ geom_text(aes(label = .group, y = emmean + SE),position=pd, hjust = -0.01) + ylab("spots per fruit emmeans")
g_d1 <-ggplot(tablamedia, aes(x=reorder(Treatment.,-emmean), y=emmean, fill=Treatment.)) + geom_col(position = "dodge")  + geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), colour = "black", width=0.1, position = pd) + geom_point(position=pd, size=3,  col = "blue")+ geom_text(aes(label = .group, y = emmean + SE),position=pd, hjust = -0.4) + ylab("Spots per fruit emmeans")
g_d1a <- g_d1 + scale_fill_grey()
g_d1a
```

Disease incidence analysis (proportionality test).

**Bellis vs Control**
```{r warning=FALSE}
prop.test(c(18,20),n=c(20,20))
```
**Ziram vs Control**
```{r warning=FALSE}
prop.test(c(19,20),n=c(20,20))
```
**Merpan vs Bellis**
```{r warning=FALSE}
prop.test(c(19,18),n=c(20,20))
```




