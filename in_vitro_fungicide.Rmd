---
title: "Inhibition of mycelial growth of S. vesicarium in vitro"
---

```{r}
pacman::p_load(
  tidyverse, 
  medrc # EC50 estimations and comparisons
  )
conflicted::conflict_prefer("filter", "dplyr")
conflicted::conflict_prefer("select", "dplyr")
```

## Mycelial growth 

```{r}
raw <- rio::import("data/mycelial_growth.csv", dec=",")
dat <- raw %>% 
  mutate_at(vars(dose, colony_diameter), as.numeric) %>% 
  mutate_at(vars(fungicide, strain, experiment, plate), as.factor) %>% 
  # mutate(dose_decimal = format(dose, scientific = FALSE) %>% str_squish()) %>% 
  # mutate(dose = as.numeric(dose_decimal)) %>% 
  mutate(curve_id = interaction(fungicide:strain:experiment)) 
```

Data scheme

```{r}
dat %>% str
ftable(xtabs(~ fungicide + strain + experiment + plate + dose, dat))
```

Exploratory plot

```{r}
dat %>% 
  ggplot()+
  facet_wrap("fungicide")  +
  aes(x=log(dose), y=colony_diameter, colour=fungicide, group=strain) +
  geom_point(size=1) 
  # geom_text(aes(label=experiment))
```

per fungicide / strain

```{r}
dat %>%  
  nest(data = c(dose, colony_diameter)) %>% 
  mutate(mod = map(data, ~broom::tidy(drm(colony_diameter~dose, fct = LL.3(), data = .))))%>%
  unnest(c(mod))%>% 
  tibble()
```

per fungicide

```{r}
dat %>%  
  nest(data = c(-fungicide)) %>% 
  mutate(mod = map(data, ~broom::tidy(drm(colony_diameter~dose, fct = LL.3(), data = .))))%>%
  unnest(c(mod)) %>% 
  tibble()
```

Meta-analysis approach

```{r}
sm1 <- metadrm(colony_diameter ~ dose, 
               data=dat,
               fct=LL.3(),
               ind=curve_id,
               cid2=fungicide,
               struct="UN")
summary(sm1)
```

Estimates 

```{r}
ED(sm1, respLev=c(50)) %>% as.data.frame()

# comparing effective dose levels for meta analysis
ed_comp <- EDcomp(sm1, 
       percVec=c(50), 
       percMat=rbind(c(1,1,1,1)), 
       interval="fieller") 

```

As we compare EC50 ratios between fungicides, if the confidence interval does not contain 1, fungicides differ among them: 

```{r}
ed_comp %>% 
  data.frame %>% 
  rownames_to_column("comp") %>% 
  ggplot()+ 
  aes(x=comp, y=Estimate) + 
  geom_pointrange(aes(ymin = Lower, ymax = Upper))+     
  geom_hline(yintercept = 1, linetype=2)+
  coord_flip()
```

Bellis < Merpan  < Timorex < Ziram

## Spore germination

```{r}
germigraf<- read.table("germination.csv", sep = ";", header = TRUE, dec=",")
germigraf$Concentration.ppm.<- as.numeric(germigraf$Concentration.ppm.)
germigraf$Repetition<- as.factor(germigraf$Repetition)
germigraf$Replicate<- as.factor(germigraf$Replicate)
germigraf %>% str
ftable(xtabs(complete.cases(Germination.percentage)~Treatment+ Concentration.ppm. , data=germigraf))
ftable(xtabs(complete.cases(Germination.percentage)~Treatment+ Concentration.ppm.+ Strain , data=germigraf))
```

## Bellis

```{r}
dat_convGB <- germigraf %>%
  filter(Treatment=="Bellis") 
dat_convGB %>% janitor::tabyl(Strain, Concentration.ppm.)
mod_fungiGB <- drm(Germination.percentage ~ Concentration.ppm.,   
                   curveid = Strain, 
                   fct = LL.3(names = c("Slope", "Upper Limit", "ED50")), 
                   data = dat_convGB)
summary(mod_fungiGB)
plot(mod_fungiGB)
EDcomp(mod_fungiGB, c(50,50))
```

## Merpan
```{r}
dat_convGC <- germigraf %>%
  filter(Treatment=="Merpan") 
dat_convGC %>% janitor::tabyl(Strain, Concentration.ppm.)
mod_fungiGC <- drm(Germination.percentage ~ Concentration.ppm.,   
                   curveid = Strain, 
                   fct = LL.3(names = c("Slope", "Upper Limit", "ED50")), 
                   data = dat_convGC)
summary(mod_fungiGC)
plot(mod_fungiGC)
EDcomp(mod_fungiGC, c(50,50))

```
## Timorex
```{r}
dat_convGT <- germigraf %>%
  filter(Treatment=="Timorex") 
dat_convGT %>% janitor::tabyl(Strain, Concentration.ppm.)
mod_fungiGT <- drm(Germination.percentage ~ Concentration.ppm.,   
                   curveid = Strain, 
                   fct = LL.3(names = c("Slope", "Upper Limit", "ED50")), 
                   data = dat_convGT)
summary(mod_fungiGT)
plot(mod_fungiGT)
EDcomp(mod_fungiGT, c(50,50))

```
## Ziram
```{r}
dat_convGZ <- germigraf %>%
  filter(Treatment=="Ziram") 
dat_convGZ %>% janitor::tabyl(Strain, Concentration.ppm.)
mod_fungiGZ <- drm(Germination.percentage ~ Concentration.ppm.,   
                   curveid = Strain, 
                   fct = LL.3(names = c("Slope", "Upper Limit", "ED50")), 
                   data = dat_convGZ)
summary(mod_fungiGZ)
plot(mod_fungiGZ)
EDcomp(mod_fungiGZ, c(50,50))
```

## General Analysis 

```{r}
mod_germigergra <- drm(Germination.percentage ~ Concentration.ppm.,   
                       curveid = Treatment, 
                       fct = LL.3(names = c("Slope", "Upper Limit", "ED50")), 
                       data = germigraf)
summary(mod_germigergra)
plot(mod_germigergra, xlab="Concentration (Âµg mL-1) ", ylab="Germination (%)",cex.lab=1.5,cex.legend = 1.2, lty=1, lwd=2)
ED(mod_germigergra, respLev = c(50), interval="delta", type = "relative")
EDcomp(mod_germigergra, c(50,50))
```
